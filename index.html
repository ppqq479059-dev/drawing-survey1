<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Four shapes</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fafafa;
      overscroll-behavior: none;
    }

    body {
      color: #111;
    }

    .hidden {
      display: none !important;
    }

    /* ë™ì˜ í™”ë©´ */
    #consentScreen {
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: #f5f5f5;
    }

    .consent-card {
      width: min(100%, 760px);
      background: #fff;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      border: 1px solid #eaeaea;
    }

    .consent-title {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 700;
    }

    .consent-sub {
      margin: 0 0 18px;
      font-size: 14px;
      color: #555;
      line-height: 1.5;
    }

    .consent-box {
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 12px;
      background: #fcfcfc;
    }

    .consent-check {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .consent-check input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 1px;
      flex: 0 0 auto;
    }

    .consent-check label {
      font-size: 16px;
      font-weight: 700;
      line-height: 1.4;
    }

    .consent-list {
      margin: 0;
      padding-left: 18px;
      color: #444;
      font-size: 14px;
      line-height: 1.6;
    }

    .consent-note {
      margin-top: 14px;
      font-size: 13px;
      color: #666;
      line-height: 1.5;
    }

    .consent-actions {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }

    .consent-btn {
      flex: 1;
      min-height: 56px;
      border: none;
      border-radius: 14px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
    }

    .consent-btn.secondary {
      background: #f0f0f0;
      color: #111;
    }

    .consent-btn.primary {
      background: #111;
      color: #fff;
    }

    .consent-btn.primary:disabled {
      background: #bbb;
      cursor: not-allowed;
    }

    /* ì•± í™”ë©´ */
    #appScreen {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      min-height: 100dvh;
      width: 100%;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .hint {
      text-align: center;
      font-size: 14px;
      color: #666;
      padding: 10px 12px;
      line-height: 1.4;
      word-break: keep-all;
    }

    .board-wrap {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 12px;
      background: #fafafa;
    }

    .board {
      position: relative;
      width: min(100%, 760px);
      aspect-ratio: 210 / 297;
      background: #fff;
      border: 1px solid #ddd;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
    }

    .guide {
      position: absolute;
      border: 1mm solid #2f5d7e;
      pointer-events: none;
      z-index: 1;
    }

    .guide-large {
      width: 57.14%;
      aspect-ratio: 1 / 1;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .guide-small {
      width: 28.57%;
      aspect-ratio: 1 / 1;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    #canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      touch-action: none;
      background: transparent;
      z-index: 2;
    }

    .tools {
      display: flex;
      gap: 12px;
      padding: 12px;
      border-top: 1px solid #eee;
      justify-content: center;
      flex-wrap: wrap;
      background: #fafafa;
    }

    .tools button {
      padding: 20px 24px;
      font-size: 28px;
      border-radius: 14px;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
      min-width: 72px;
      min-height: 72px;
    }

    .tools button:active {
      transform: scale(0.96);
    }

    .inputs {
      display: flex;
      gap: 10px;
      padding: 12px;
      width: 100%;
    }

    .inputs input {
      flex: 1;
      min-width: 0;
      width: 100%;
      padding: 18px;
      font-size: 18px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .submit {
      padding: 22px;
      font-size: 20px;
      width: 100%;
      background: #111;
      color: #fff;
      border: none;
      border-radius: 0;
      cursor: pointer;
      min-height: 72px;
    }

    .submit:active {
      background: #000;
    }

    @media (max-width: 1024px) {
      .board {
        width: min(100%, 78vw);
      }
    }

    @media (max-width: 768px) {
      .consent-card {
        padding: 16px;
        border-radius: 16px;
      }

      .consent-title {
        font-size: 22px;
      }

      .consent-check label {
        font-size: 15px;
      }

      .consent-list {
        font-size: 13px;
      }

      .consent-actions {
        flex-direction: column;
      }

      .hint {
        font-size: 13px;
        padding: 8px 10px;
      }

      .board-wrap {
        padding: 10px;
      }

      .board {
        width: min(100%, 92vw);
      }

      .tools {
        gap: 8px;
        padding: 10px;
      }

      .tools button {
        padding: 16px 18px;
        font-size: 24px;
        min-width: 60px;
        min-height: 60px;
      }

      .inputs {
        flex-direction: column;
        gap: 8px;
        padding: 10px;
      }

      .inputs input {
        font-size: 16px;
        padding: 14px;
      }

      .submit {
        font-size: 18px;
        padding: 18px;
        min-height: 64px;
      }
    }

    @media (max-width: 430px) {
      .consent-title {
        font-size: 20px;
      }

      .consent-sub {
        font-size: 13px;
      }

      .hint {
        font-size: 12px;
      }

      .board-wrap {
        padding: 8px;
      }

      .board {
        width: min(100%, 96vw);
      }

      .tools {
        gap: 6px;
        padding: 8px;
      }

      .tools button {
        padding: 14px 16px;
        font-size: 22px;
        min-width: 54px;
        min-height: 54px;
        border-radius: 12px;
      }

      .inputs {
        padding: 8px;
      }

      .inputs input {
        font-size: 15px;
        padding: 12px;
      }

      .submit {
        font-size: 17px;
        padding: 16px;
        min-height: 58px;
      }
    }
  </style>
</head>
<body>
  <section id="consentScreen">
    <div class="consent-card">
      <h1 class="consent-title">ì„¤ë¬¸ ì°¸ì—¬ ë™ì˜</h1>
      <p class="consent-sub">
        ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•œ ë’¤ ë™ì˜í•´ ì£¼ì„¸ìš”. í•„ìˆ˜ ë™ì˜ì— ì²´í¬í•´ì•¼ ì„¤ë¬¸ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>

      <div class="consent-box">
        <div class="consent-check">
          <input type="checkbox" id="agreeRequired">
          <label for="agreeRequired">[í•„ìˆ˜] ë“œë¡œì‰ ê²°ê³¼ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
        </div>
        <ul class="consent-list">
          <li>ëª©ì : ë“œë¡œì‰ ì„¤ë¬¸ ì§„í–‰ ë° ê²°ê³¼ ë¶„ì„</li>
          <li>í•­ëª©: ë“œë¡œì‰ ê²°ê³¼ ì´ë¯¸ì§€, ì°¸ì—¬ ì¼ì‹œ</li>
          <li>ë³´ìœ  ê¸°ê°„: ì¡°ì‚¬ ì¢…ë£Œ í›„ ë‚´ë¶€ ê¸°ì¤€ì— ë”°ë¼ ë³´ê´€ í›„ íŒŒê¸°</li>
          <li>ê±°ë¶€ ê¶Œë¦¬: ë™ì˜ë¥¼ ê±°ë¶€í•  ìˆ˜ ìˆìœ¼ë‚˜, ê±°ë¶€ ì‹œ ì„¤ë¬¸ ì°¸ì—¬ê°€ ì œí•œë©ë‹ˆë‹¤.</li>
        </ul>
      </div>

      <div class="consent-box">
        <div class="consent-check">
          <input type="checkbox" id="agreeOptional">
          <label for="agreeOptional">[ì„ íƒ] ì´ë¦„Â·ì—°ë½ì²˜ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
        </div>
        <ul class="consent-list">
          <li>ëª©ì : ì°¸ì—¬ì ì‹ë³„, ì‚¬í›„ ì—°ë½ ë˜ëŠ” ì•ˆë‚´(í•„ìš” ì‹œ)</li>
          <li>í•­ëª©: ì´ë¦„, ì—°ë½ì²˜</li>
          <li>ë³´ìœ  ê¸°ê°„: ëª©ì  ë‹¬ì„± í›„ ë‚´ë¶€ ê¸°ì¤€ì— ë”°ë¼ ë³´ê´€ í›„ íŒŒê¸°</li>
          <li>ê±°ë¶€ ê¶Œë¦¬: ë™ì˜ë¥¼ ê±°ë¶€í•´ë„ ë“œë¡œì‰ ì„¤ë¬¸ ì°¸ì—¬ëŠ” ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        </ul>
      </div>

      <p class="consent-note">
        ë§Œ 14ì„¸ ë¯¸ë§Œì€ ë²•ì •ëŒ€ë¦¬ì¸ì˜ ë™ì˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹¤ì œ ìš´ì˜ ì‹œ ë³´ìœ  ê¸°ê°„ê³¼ íŒŒê¸° ê¸°ì¤€ì€ ì¡°ì‚¬ ëª©ì ì— ë§ê²Œ êµ¬ì²´ì ìœ¼ë¡œ ê¸°ì¬í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
      </p>

      <div class="consent-actions">
        <button class="consent-btn secondary" type="button" id="declineBtn">ë™ì˜í•˜ì§€ ì•ŠìŒ</button>
        <button class="consent-btn primary" type="button" id="startBtn" disabled>ë™ì˜í•˜ê³  ì‹œì‘</button>
      </div>
    </div>
  </section>

  <main id="appScreen" class="hidden">
    <div class="hint">S â–¡ â–³ â—‹ â€” ë°©ì‹ì€ ììœ ë¡­ê²Œ</div>

    <div class="board-wrap">
      <div id="board" class="board">
        <div class="guide guide-large"></div>
        <div class="guide guide-small"></div>
        <canvas id="canvas"></canvas>
      </div>
    </div>

    <div class="tools">
      <button id="pen" type="button">âœï¸</button>
      <button id="eraser" type="button">ğŸ§½</button>
      <button id="undo" type="button">â†©ï¸</button>
      <button id="clear" type="button">ğŸ—‘ï¸</button>
    </div>

    <div class="inputs hidden" id="contactFields">
      <input id="name" placeholder="ì´ë¦„ (ì„ íƒ)">
      <input id="contact" placeholder="ì—°ë½ì²˜ (ì„ íƒ)">
    </div>

    <button class="submit" id="submit" type="button">ì œì¶œ & PNG ì €ì¥</button>
  </main>

  <script>
    const consentScreen = document.getElementById('consentScreen');
    const appScreen = document.getElementById('appScreen');
    const agreeRequired = document.getElementById('agreeRequired');
    const agreeOptional = document.getElementById('agreeOptional');
    const startBtn = document.getElementById('startBtn');
    const declineBtn = document.getElementById('declineBtn');
    const contactFields = document.getElementById('contactFields');

    const board = document.getElementById('board');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const pen = document.getElementById('pen');
    const eraser = document.getElementById('eraser');
    const undo = document.getElementById('undo');
    const clearBtn = document.getElementById('clear');
    const submitBtn = document.getElementById('submit');
    const nameInput = document.getElementById('name');
    const contactInput = document.getElementById('contact');

    let drawing = false;
    let erasing = false;
    let drawHistory = [];
    let saving = false;

    function updateConsentUI() {
      startBtn.disabled = !agreeRequired.checked;
      contactFields.classList.toggle('hidden', !agreeOptional.checked);

      if (!agreeOptional.checked) {
        nameInput.value = '';
        contactInput.value = '';
      }
    }

    agreeRequired.addEventListener('change', updateConsentUI);
    agreeOptional.addEventListener('change', updateConsentUI);

    declineBtn.addEventListener('click', () => {
      alert('í•„ìˆ˜ ë™ì˜ê°€ ì—†ìœ¼ë©´ ì„¤ë¬¸ì„ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    });

    startBtn.addEventListener('click', () => {
      if (!agreeRequired.checked) {
        alert('í•„ìˆ˜ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      consentScreen.classList.add('hidden');
      appScreen.classList.remove('hidden');

      setTimeout(() => {
        resizeCanvas();
      }, 50);
    });

    function resizeCanvas() {
      const rect = board.getBoundingClientRect();
      if (!rect.width || !rect.height) return;

      let prev = null;
      try {
        if (canvas.width > 0 && canvas.height > 0) {
          prev = canvas.toDataURL();
        }
      } catch (e) {}

      canvas.width = rect.width;
      canvas.height = rect.height;

      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      if (prev) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = prev;
      }
    }

    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', () => {
      setTimeout(resizeCanvas, 200);
    });

    function saveState() {
      drawHistory.push(canvas.toDataURL());
      if (drawHistory.length > 10) drawHistory.shift();
    }

    function getPos(e) {
      const r = canvas.getBoundingClientRect();
      const p = e.touches ? e.touches[0] : e;
      return {
        x: p.clientX - r.left,
        y: p.clientY - r.top
      };
    }

    function start(e) {
      e.preventDefault();
      drawing = true;
      saveState();
      ctx.beginPath();
      const { x, y } = getPos(e);
      ctx.moveTo(x, y);
    }

    function move(e) {
      if (!drawing) return;
      e.preventDefault();

      const { x, y } = getPos(e);

      ctx.lineWidth = erasing ? 26 : 4;
      ctx.lineCap = 'round';

      if (erasing) {
        ctx.globalCompositeOperation = 'destination-out';
      } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = '#000';
      }

      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function end() {
      drawing = false;
      ctx.beginPath();
      ctx.globalCompositeOperation = 'source-over';
    }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    canvas.addEventListener('mouseup', end);
    canvas.addEventListener('mouseleave', end);

    canvas.addEventListener('touchstart', start, { passive: false });
    canvas.addEventListener('touchmove', move, { passive: false });
    canvas.addEventListener('touchend', end);
    canvas.addEventListener('touchcancel', end);

    pen.onclick = () => {
      erasing = false;
    };

    eraser.onclick = () => {
      erasing = true;
    };

    undo.onclick = () => {
      const last = drawHistory.pop();
      if (!last) return;

      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
      img.src = last;
    };

    clearBtn.onclick = () => {
      if (!confirm('ì „ë¶€ ì§€ìš¸ê¹Œìš”?')) return;
      saveState();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    submitBtn.onclick = async () => {
      if (saving) return;
      saving = true;

      if (!agreeRequired.checked) {
        saving = false;
        alert('í•„ìˆ˜ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      if (!confirm('ì œì¶œí•˜ê³  ì „ì²´ í™”ë©´ì„ PNGë¡œ ì €ì¥í• ê¹Œìš”?')) {
        saving = false;
        return;
      }

      try {
        const target = document.getElementById('appScreen');

        const canvasImg = await html2canvas(target, {
          backgroundColor: '#fafafa',
          scale: 2,
          windowWidth: target.scrollWidth,
          windowHeight: target.scrollHeight
        });

        const link = document.createElement('a');
        const ts = new Date().toISOString().replace(/[:.]/g, '-');
        const safeName = agreeOptional.checked && nameInput.value.trim()
          ? nameInput.value.trim()
          : 'anon';

        link.download = `drawing_${ts}_${safeName}.png`;
        link.href = canvasImg.toDataURL('image/png');
        link.click();

        setTimeout(() => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          nameInput.value = '';
          contactInput.value = '';
          agreeOptional.checked = false;
          drawHistory = [];
          saving = false;
          updateConsentUI();
          alert('ì €ì¥ ì™„ë£Œ! ë‹¤ìŒ ë¶„ ì¤€ë¹„ëì–´ìš”.');
        }, 400);
      } catch (err) {
        saving = false;
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
      }
    };

    window.history.pushState(null, "", location.href);
    window.onpopstate = () => window.history.pushState(null, "", location.href);

    updateConsentUI();
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
</body>
</html>
