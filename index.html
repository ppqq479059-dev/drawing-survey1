<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>í˜„ì¥ ë“œë¡œì‰ ì„¤ë¬¸ (ìµœì¢…ë³¸)</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #fafafa;
      overscroll-behavior: none;
    }
    #wrap {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .hint {
      text-align: center;
      font-size: 14px;
      color: #666;
      padding: 10px;
    }

    #canvas {
      flex: 1;
      background: #fff;
      touch-action: none;
      display: block;
      width: 100%;
    }

    .tools {
      display: flex;
      gap: 12px;
      padding: 12px;
      border-top: 1px solid #eee;
      justify-content: center;
      flex-wrap: wrap;
    }

    .tools button {
      padding: 22px 26px;
      font-size: 30px;
      border-radius: 14px;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
    }

    .tools button:active {
      transform: scale(0.96);
    }

    .inputs {
      display: flex;
      gap: 10px;
      padding: 12px;
    }

    .inputs input {
      flex: 1;
      padding: 18px;
      font-size: 18px;
      border-radius: 12px;
      border: 1px solid #ddd;
    }

    .submit {
      padding: 22px;
      font-size: 20px;
      width: 100%;
      background: #111;
      color: #fff;
      border: none;
      border-radius: 0;
      cursor: pointer;
    }

    .submit:active {
      background: #000;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="hint">ì˜ê° ì˜ˆì‹œ: S â–¡ â–³ â—‹ â€” ë°©ì‹ì€ ììœ ë¡­ê²Œ</div>

    <canvas id="canvas"></canvas>

    <div class="tools">
      <button id="pen" type="button">âœï¸</button>
      <button id="eraser" type="button">ğŸ§½</button>
      <button id="undo" type="button">â†©ï¸</button>
      <button id="clear" type="button">ğŸ—‘ï¸</button>
    </div>

    <div class="inputs">
      <input id="name" placeholder="ì´ë¦„ (ì„ íƒ)">
      <input id="contact" placeholder="ì—°ë½ì²˜ (ì„ íƒ)">
    </div>

    <button class="submit" id="submit" type="button">ì œì¶œ & PNG ì €ì¥</button>
  </div>

  <script>
    const wrap = document.getElementById('wrap');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const pen = document.getElementById('pen');
    const eraser = document.getElementById('eraser');
    const undo = document.getElementById('undo');
    const clearBtn = document.getElementById('clear');
    const submitBtn = document.getElementById('submit');

    let drawing = false;
    let erasing = false;
    let drawHistory = [];
    let saving = false;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();

      let prev = null;
      try {
        if (canvas.width > 0 && canvas.height > 0) {
          prev = canvas.toDataURL();
        }
      } catch (e) {}

      canvas.width = rect.width;
      canvas.height = rect.height;

      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      if (prev) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0);
        img.src = prev;
      }
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function saveState() {
      drawHistory.push(canvas.toDataURL());
      if (drawHistory.length > 10) drawHistory.shift();
    }

    function getPos(e) {
      const r = canvas.getBoundingClientRect();
      const p = e.touches ? e.touches[0] : e;
      return {
        x: p.clientX - r.left,
        y: p.clientY - r.top
      };
    }

    function start(e) {
      e.preventDefault();
      drawing = true;
      saveState();
      ctx.beginPath();
      const { x, y } = getPos(e);
      ctx.moveTo(x, y);
    }

    function move(e) {
      if (!drawing) return;
      e.preventDefault();

      const { x, y } = getPos(e);

      ctx.lineWidth = erasing ? 26 : 4;
      ctx.lineCap = 'round';

      if (erasing) {
        ctx.globalCompositeOperation = 'destination-out';
      } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = '#000';
      }

      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function end() {
      drawing = false;
      ctx.beginPath();
      ctx.globalCompositeOperation = 'source-over';
    }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    canvas.addEventListener('mouseup', end);
    canvas.addEventListener('mouseleave', end);

    canvas.addEventListener('touchstart', start, { passive: false });
    canvas.addEventListener('touchmove', move, { passive: false });
    canvas.addEventListener('touchend', end);

    pen.onclick = () => {
      erasing = false;
    };

    eraser.onclick = () => {
      erasing = true;
    };

    undo.onclick = () => {
      const last = drawHistory.pop();
      if (!last) return;

      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
      };
      img.src = last;
    };

    clearBtn.onclick = () => {
      if (!confirm('ì „ë¶€ ì§€ìš¸ê¹Œìš”?')) return;
      saveState();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    submitBtn.onclick = async () => {
      if (saving) return;
      saving = true;

      if (!confirm('ì œì¶œí•˜ê³  ì „ì²´ í™”ë©´ì„ PNGë¡œ ì €ì¥í• ê¹Œìš”?')) {
        saving = false;
        return;
      }

      try {
        const canvasImg = await html2canvas(wrap, {
          backgroundColor: '#fafafa',
          scale: 2,
          windowWidth: wrap.scrollWidth,
          windowHeight: wrap.scrollHeight
        });

        const link = document.createElement('a');
        const ts = new Date().toISOString().replace(/[:.]/g, '-');
        const name = document.getElementById('name').value || 'anon';

        link.download = `drawing_${ts}_${name}.png`;
        link.href = canvasImg.toDataURL('image/png');
        link.click();

        setTimeout(() => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          document.getElementById('name').value = '';
          document.getElementById('contact').value = '';
          drawHistory = [];
          saving = false;
          alert('ì €ì¥ ì™„ë£Œ! ë‹¤ìŒ ë¶„ ì¤€ë¹„ëì–´ìš”.');
        }, 400);
      } catch (err) {
        saving = false;
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.');
      }
    };

    // ë’¤ë¡œê°€ê¸° ë°©ì§€
    window.history.pushState(null, "", location.href);
    window.onpopstate = () => window.history.pushState(null, "", location.href);
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
</body>
</html>
