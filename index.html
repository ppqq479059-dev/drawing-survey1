<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Four shapes</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fafafa;
      overscroll-behavior: none;
    }

    body {
      color: #111;
    }

    #wrap {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      min-height: 100dvh;
      width: 100%;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .hint {
      text-align: center;
      font-size: 14px;
      color: #666;
      padding: 10px 12px;
      line-height: 1.4;
      word-break: keep-all;
    }

    .board-wrap {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 12px;
      background: #fafafa;
    }

    .board {
      position: relative;
      width: min(100%, 560px);
      aspect-ratio: 210 / 297; /* A4 ÏÑ∏Î°ú */
      background: #fff;
      border: 1px solid #ddd;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
    }

    .guide {
      position: absolute;
      border: 2px solid #2f5d7e;
      pointer-events: none;
    }

    /* A4 Í∞ÄÎ°ú 21cm Í∏∞Ï§ÄÏóêÏÑú 12cm = 57.14% */
    .guide-large {
      width: 57.14%;
      aspect-ratio: 1 / 1;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    /* A4 Í∞ÄÎ°ú 21cm Í∏∞Ï§ÄÏóêÏÑú 6cm = 28.57% */
    .guide-small {
      width: 28.57%;
      aspect-ratio: 1 / 1;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    #canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      touch-action: none;
      background: transparent;
    }

    .tools {
      display: flex;
      gap: 12px;
      padding: 12px;
      border-top: 1px solid #eee;
      justify-content: center;
      flex-wrap: wrap;
      background: #fafafa;
    }

    .tools button {
      padding: 20px 24px;
      font-size: 28px;
      border-radius: 14px;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
      min-width: 72px;
      min-height: 72px;
    }

    .tools button:active {
      transform: scale(0.96);
    }

    .inputs {
      display: flex;
      gap: 10px;
      padding: 12px;
      width: 100%;
    }

    .inputs input {
      flex: 1;
      min-width: 0;
      width: 100%;
      padding: 18px;
      font-size: 18px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .submit {
      padding: 22px;
      font-size: 20px;
      width: 100%;
      background: #111;
      color: #fff;
      border: none;
      border-radius: 0;
      cursor: pointer;
      min-height: 72px;
    }

    .submit:active {
      background: #000;
    }

    @media (max-width: 768px) {
      .hint {
        font-size: 13px;
        padding: 8px 10px;
      }

      .board-wrap {
        padding: 10px;
      }

      .board {
        width: min(100%, 92vw);
      }

      .tools {
        gap: 8px;
        padding: 10px;
      }

      .tools button {
        padding: 16px 18px;
        font-size: 24px;
        min-width: 60px;
        min-height: 60px;
      }

      .inputs {
        flex-direction: column;
        gap: 8px;
        padding: 10px;
      }

      .inputs input {
        font-size: 16px;
        padding: 14px;
      }

      .submit {
        font-size: 18px;
        padding: 18px;
        min-height: 64px;
      }
    }

    @media (max-width: 430px) {
      .hint {
        font-size: 12px;
      }

      .board-wrap {
        padding: 8px;
      }

      .board {
        width: min(100%, 96vw);
      }

      .tools {
        gap: 6px;
        padding: 8px;
      }

      .tools button {
        padding: 14px 16px;
        font-size: 22px;
        min-width: 54px;
        min-height: 54px;
        border-radius: 12px;
      }

      .inputs {
        padding: 8px;
      }

      .inputs input {
        font-size: 15px;
        padding: 12px;
      }

      .submit {
        font-size: 17px;
        padding: 16px;
        min-height: 58px;
      }
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="hint">A4 ÏÑ∏Î°ú Í∏∞Ï§Ä ¬∑ Ï§ëÏïô 12√ó12 Ï†ïÏÇ¨Í∞ÅÌòï ¬∑ Í∑∏ ÏïàÏóê Ï§ëÏïô 6√ó6 Ï†ïÏÇ¨Í∞ÅÌòï</div>

    <div class="board-wrap">
      <div id="board" class="board">
        <div class="guide guide-large"></div>
        <div class="guide guide-small"></div>
        <canvas id="canvas"></canvas>
      </div>
    </div>

    <div class="tools">
      <button id="pen" type="button">‚úèÔ∏è</button>
      <button id="eraser" type="button">üßΩ</button>
      <button id="undo" type="button">‚Ü©Ô∏è</button>
      <button id="clear" type="button">üóëÔ∏è</button>
    </div>

    <div class="inputs">
      <input id="name" placeholder="Ïù¥Î¶Ñ (ÏÑ†ÌÉù)">
      <input id="contact" placeholder="Ïó∞ÎùΩÏ≤ò (ÏÑ†ÌÉù)">
    </div>

    <button class="submit" id="submit" type="button">Ï†úÏ∂ú & PNG Ï†ÄÏû•</button>
  </div>

  <script>
    const wrap = document.getElementById('wrap');
    const board = document.getElementById('board');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const pen = document.getElementById('pen');
    const eraser = document.getElementById('eraser');
    const undo = document.getElementById('undo');
    const clearBtn = document.getElementById('clear');
    const submitBtn = document.getElementById('submit');

    let drawing = false;
    let erasing = false;
    let drawHistory = [];
    let saving = false;

    function resizeCanvas() {
      const rect = board.getBoundingClientRect();

      let prev = null;
      try {
        if (canvas.width > 0 && canvas.height > 0) {
          prev = canvas.toDataURL();
        }
      } catch (e) {}

      canvas.width = rect.width;
      canvas.height = rect.height;

      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      if (prev) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = prev;
      }
    }

    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', () => {
      setTimeout(resizeCanvas, 200);
    });
    resizeCanvas();

    function saveState() {
      drawHistory.push(canvas.toDataURL());
      if (drawHistory.length > 10) drawHistory.shift();
    }

    function getPos(e) {
      const r = canvas.getBoundingClientRect();
      const p = e.touches ? e.touches[0] : e;
      return {
        x: p.clientX - r.left,
        y: p.clientY - r.top
      };
    }

    function start(e) {
      e.preventDefault();
      drawing = true;
      saveState();
      ctx.beginPath();
      const { x, y } = getPos(e);
      ctx.moveTo(x, y);
    }

    function move(e) {
      if (!drawing) return;
      e.preventDefault();

      const { x, y } = getPos(e);

      ctx.lineWidth = erasing ? 26 : 4;
      ctx.lineCap = 'round';

      if (erasing) {
        ctx.globalCompositeOperation = 'destination-out';
      } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = '#000';
      }

      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function end() {
      drawing = false;
      ctx.beginPath();
      ctx.globalCompositeOperation = 'source-over';
    }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    canvas.addEventListener('mouseup', end);
    canvas.addEventListener('mouseleave', end);

    canvas.addEventListener('touchstart', start, { passive: false });
    canvas.addEventListener('touchmove', move, { passive: false });
    canvas.addEventListener('touchend', end);
    canvas.addEventListener('touchcancel', end);

    pen.onclick = () => {
      erasing = false;
    };

    eraser.onclick = () => {
      erasing = true;
    };

    undo.onclick = () => {
      const last = drawHistory.pop();
      if (!last) return;

      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
      img.src = last;
    };

    clearBtn.onclick = () => {
      if (!confirm('Ï†ÑÎ∂Ä ÏßÄÏö∏ÍπåÏöî?')) return;
      saveState();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    submitBtn.onclick = async () => {
      if (saving) return;
      saving = true;

      if (!confirm('Ï†úÏ∂úÌïòÍ≥† Ï†ÑÏ≤¥ ÌôîÎ©¥ÏùÑ PNGÎ°ú Ï†ÄÏû•Ìï†ÍπåÏöî?')) {
        saving = false;
        return;
      }

      try {
        const canvasImg = await html2canvas(wrap, {
          backgroundColor: '#fafafa',
          scale: 2,
          windowWidth: wrap.scrollWidth,
          windowHeight: wrap.scrollHeight
        });

        const link = document.createElement('a');
        const ts = new Date().toISOString().replace(/[:.]/g, '-');
        const name = document.getElementById('name').value || 'anon';

        link.download = `drawing_${ts}_${name}.png`;
        link.href = canvasImg.toDataURL('image/png');
        link.click();

        setTimeout(() => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          document.getElementById('name').value = '';
          document.getElementById('contact').value = '';
          drawHistory = [];
          saving = false;
          alert('Ï†ÄÏû• ÏôÑÎ£å! Îã§Ïùå Î∂Ñ Ï§ÄÎπÑÎêêÏñ¥Ïöî.');
        }, 400);
      } catch (err) {
        saving = false;
        alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî.');
      }
    };

    window.history.pushState(null, "", location.href);
    window.onpopstate = () => window.history.pushState(null, "", location.href);
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
</body>
</html>
